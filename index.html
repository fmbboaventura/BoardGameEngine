<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>Board Game</title>
        <script src="//cdn.jsdelivr.net/phaser/2.5.0/phaser.min.js"></script>
    </head>
    <body>

      <script type="text/javascript">
        function require(url){
          if (url.toLowerCase().substr(-3)!=='.js') url+='.js'; // to allow loading without js suffix;
          if (!require.cache) require.cache=[]; //init cache
          var exports=require.cache[url]; //get from cache
          if (!exports) { //not cached
            try {
              exports={};
              var X=new XMLHttpRequest();
              X.open("GET", url, 0); // sync
              X.send();
              if (X.status && X.status !== 200)  throw new Error(X.statusText);
              var source = X.responseText;
              // fix (if saved form for Chrome Dev Tools)
              if (source.substr(0,10)==="(function("){
                var moduleStart = source.indexOf('{');
                var moduleEnd = source.lastIndexOf('})');
                var CDTcomment = source.indexOf('//@ ');
                if (CDTcomment>-1 && CDTcomment<moduleStart+6) moduleStart = source.indexOf('\n',CDTcomment);
                source = source.slice(moduleStart+1,moduleEnd-1);
              }
              // fix, add comment to show source on Chrome Dev Tools
              source="//@ sourceURL="+window.location.origin+url+"\n" + source;
              //------
              var module = { id: url, uri: url, exports:exports }; //according to node.js modules
              var anonFn = new Function("require", "exports", "module", source); //create a Fn with module code, and 3 params: require, exports & module
              anonFn(require, exports, module); // call the Fn, Execute the module
              require.cache[url]  = exports = module.exports; //cache obj exported by module
            } catch (err) {
              throw new Error("Error loading module "+url+": "+err);
            }
          }
          return exports; //require returns object exported by module
        }

        window.onload = function () {
          var gameState = "";

          var backgroundWidth = 0;
          var backgroundHeight = 0;
          var pawnWidth = 0;
          var pawnHeight = 0;

          var pawnSprite = {};

          var boardGameAdapter = require('./BoardGameAdapter.js');
          boardGameAdapter.setGameConfig("./Ludo.js");

          // console.log(boardGameAdapter.getGameConfig("gameData").component.tokens[0].tokenImg);
          // console.log(boardGameAdapter.getGameConfig("gameData").board.background);

          var game = new Phaser.Game(800, 600, Phaser.AUTO, '', { preload: preload, create: create });

          function button1OnClick () {
            // var pawn = boardGameAdapter.getGameConfig("gameData").component.tokens[0];
            // var posId = pawn.positionId
            // var pos = boardGameAdapter.getGameConfig("gameData").board.positions[posId];
            // pos = boardGameAdapter.getGameConfig("gameData").board.positions[pos.next[0]];
            // pawn.positionId = pos.positionId;
            //
            // pawnSprite.x = backgroundWidth*pos.location[0]-(pawnWidth/2);
            // pawnSprite.y = backgroundHeight*pos.location[1]-(pawnHeight/2);
            // console.log("clicou: " + pawnSprite.x + " " + pawnSprite.y + " " + pos.positionType + " " + pos.positionId);
            // console.log(boardGameAdapter.getGameConfig("gameData").board.positions);
          }

          // Carregando as imagens do jogo
          function preload() {
            // TODO remover
            game.load.image('button1', 'button1.png');

            // Carregando tabuleiro
            game.load.image('background', boardGameAdapter.getGameConfig("boardBackground"));

            // Carregando icones dos atributos do jogador
            boardGameAdapter.getGameConfig("playerAttributeImg").forEach(function (playerAttributeImg, attributeName) {
              game.load.image(attributeName, playerAttributeImg);
            });

            // Carregando icones dos tokens
            boardGameAdapter.getGameConfig("tokenImg").forEach(function (tokenImg, tokenType) {
              game.load.image(tokenType, tokenImg);
            });
          }


          // Insere os componentes do jogo no mundo
          function create() {
            game.add.sprite(0, 0, 'background');

            // var posId = boardGameAdapter.getGameConfig("gameData").component.tokens[0].positionId
            // var pos = boardGameAdapter.getGameConfig("gameData").board.positions[posId];
            //
            // var backgroundImg = game.cache.getImage('background1');
            // backgroundWidth = backgroundImg.width;
            // backgroundHeight = backgroundImg.height;
            //
            // var pawnImg = game.cache.getImage('pawn');
            // pawnWidth = pawnImg.width;
            // pawnHeight = pawnImg.height;
            //
            // pawnSprite = game.add.sprite(
            //     backgroundWidth*pos.location[0]-(pawnWidth/2),
            //     backgroundHeight*pos.location[1]-(pawnHeight/2), 'pawn'
            // );

            game.add.button(50, 50, 'button1', button1OnClick);
          }

          function perform() {
            switch (gameState) {
              case "ready":

                break;
              default:

            }
          }

        }
      </script>

      <h3 id="message">Welcome! Messages are displayed here</h3>

    </body>
</html>
